import { Callout, Tabs, Tab } from 'nextra/components'

# Whisper Protocol Specification

<Callout type="warning">
  This protocol documentation is intended for developers and system architects. For general usage information, please refer to the [user guide](/demo).
</Callout>

## Protocol Overview

Whisper utilizes a custom protocol built on top of WebSockets to enable secure, real-time communication between clients. The protocol is designed with the following goals in mind:

-   **Security**: End-to-end encryption for all messages
-   **Efficiency**: Minimal overhead for low-latency communication
-   **Reliability**: Message delivery guarantees with acknowledgments
-   **Extensibility**: Flexible message format for future enhancements

## Message Format

All messages in the Whisper protocol follow a standardized JSON format:

```json
{
    "type": "message_type",
    "id": "unique_message_id",
    "timestamp": 1634567890123,
    "sender": "user_id",
    "recipient": "recipient_id",
    "content": {
        // Message-specific payload
    },
    "metadata": {
        // Additional message metadata
    }
}
```

### Message Types

The `type` field indicates the purpose of the message. Common message types include:

| Type       | Description                            |
| ---------- | -------------------------------------- |
| `text`     | Standard text message                  |
| `media`    | Media message (image, video, document) |
| `typing`   | Typing indicator                       |
| `read`     | Read receipt                           |
| `presence` | User presence update                   |
| `system`   | System notification                    |

## Encryption

Whisper implements end-to-end encryption using the Signal Protocol, which provides:

-   Perfect forward secrecy
-   Post-compromise security
-   Deniable authentication

<Tabs items={['Key Exchange', 'Message Encryption', 'Verification']}>
<Tab> 
### Key Exchange Process

    1. **Initial Registration**:
       - Client generates identity key pair (IK)
       - Client generates signed pre-key (SPK) and signature
       - Client generates one-time pre-keys (OPK)
       - Client uploads public keys to server

    2. **Session Establishment**:
       - Initiator fetches recipient's public keys
       - Initiator generates ephemeral key pair
       - Initiator computes shared secret using X3DH protocol
       - Initiator sends initial message with key information

  </Tab>
  <Tab>
    ### Message Encryption

    Whisper uses the Double Ratchet Algorithm for message encryption:

    1. **Ratchet Initialization**:
       - Initialize root key from key exchange
       - Derive initial chain keys

    2. **Sending Messages**:
       - Generate message key from sender chain
       - Encrypt message with message key
       - Update sender chain key

    3. **Receiving Messages**:
       - Decrypt message with corresponding message key
       - Update receiver chain key

  </Tab>
  <Tab>
    ### Verification Mechanism

    Whisper provides multiple verification methods to ensure the authenticity of communications:

    - **Safety Numbers**: Users can verify each other's identity by comparing safety numbers
    - **QR Code Verification**: Scan a QR code to verify a contact's identity
    - **Out-of-Band Verification**: Use an external secure channel to verify identity

    When a security event occurs (e.g., a contact reinstalls the app), users are notified about the change in safety numbers.

  </Tab>
</Tabs>

## Transport Layer

Whisper uses WebSockets as the primary transport layer, with HTTP long-polling as a fallback mechanism:

-   **WebSockets**: Provides bi-directional, full-duplex communication channels over a single TCP connection
-   **HTTP Fallback**: Used in environments where WebSockets are not supported or are blocked

## Message Flow

1. **Connection Establishment**:

    - Client connects to the Whisper server via WebSocket
    - Client authenticates using JWT or similar token
    - Server verifies authentication and establishes session

2. **Message Sending**:

    - Client encrypts message using recipient's public key
    - Client sends encrypted message to server
    - Server validates message and forwards to recipient(s)
    - Recipient acknowledges receipt
    - Server confirms delivery to sender

3. **Offline Handling**:
    - If recipient is offline, server stores message
    - When recipient comes online, server delivers queued messages
    - Messages expire after a configurable TTL (Time To Live)

## Rate Limiting and Quotas

To prevent abuse and ensure fair usage, Whisper implements rate limiting and quotas:

-   Maximum message rate: 100 messages per minute per user
-   Maximum connections: 5 concurrent connections per user
-   Message size limit: 10MB for media, 4KB for text

## API Reference

For detailed API documentation, please refer to the [Whisper API Reference](/api).

## Protocol Versioning

The Whisper protocol uses semantic versioning (MAJOR.MINOR.PATCH):

-   Current version: 1.2.0
-   Backward compatibility is maintained within the same MAJOR version

<Callout type="info">
  Clients should negotiate protocol version during connection establishment to ensure compatibility.
</Callout>

export default ({ children }) => (

  <div className="max-w-screen-xl mx-auto px-4 py-8">
    {children}
  </div>
);
