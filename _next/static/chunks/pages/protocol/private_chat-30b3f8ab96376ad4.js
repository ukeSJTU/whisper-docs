(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7587],{8686:function(s,e,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/protocol/private_chat",function(){return n(2534)}])},2534:function(s,e,n){"use strict";n.r(e),n.d(e,{__toc:function(){return t}});var r=n(5893),i=n(2673),l=n(5417),c=n(3209);n(4759);var o=n(2643);let t=[{depth:2,value:"概述",id:"概述"},{depth:2,value:"3.1. 发送私聊消息 (Send Private Message)",id:"31-发送私聊消息-send-private-message"},{depth:3,value:"SEND_PRIVATE_CHAT_MESSAGE_REQUEST (Client -> Server)",id:"send_private_chat_message_request-client---server"},{depth:3,value:"PRIVATE_CHAT_MESSAGE_SENT_ACK (Server -> Client, to Sender)",id:"private_chat_message_sent_ack-server---client-to-sender"},{depth:2,value:"3.2. 接收私聊消息 (Receive Private Message)",id:"32-接收私聊消息-receive-private-message"},{depth:3,value:"RECEIVE_PRIVATE_CHAT_MESSAGE_NOTIFICATION (Server -> Client, to Recipient)",id:"receive_private_chat_message_notification-server---client-to-recipient"},{depth:2,value:"3.3. 撤回私聊消息 (Recall Private Message)",id:"33-撤回私聊消息-recall-private-message"},{depth:3,value:"3.3.1. RECALL_PRIVATE_CHAT_MESSAGE_REQUEST (Client -> Server, from Sender)",id:"331-recall_private_chat_message_request-client---server-from-sender"},{depth:3,value:"3.3.2. PRIVATE_CHAT_MESSAGE_RECALLED_ACK (Server -> Client, to Sender)",id:"332-private_chat_message_recalled_ack-server---client-to-sender"},{depth:3,value:"3.3.3. RECEIVE_PRIVATE_CHAT_MESSAGE_RECALL_NOTIFICATION (Server -> Client, to Recipient)",id:"333-receive_private_chat_message_recall_notification-server---client-to-recipient"},{depth:2,value:"撤回消息处理规则 (Message Recall Handling Rules)",id:"撤回消息处理规则-message-recall-handling-rules"},{depth:3,value:"服务器处理规则:",id:"服务器处理规则"},{depth:3,value:"客户端处理规则 (发送方):",id:"客户端处理规则-发送方"},{depth:3,value:"客户端处理规则 (接收方):",id:"客户端处理规则-接收方"},{depth:3,value:"对 E2EE 模式的影响:",id:"对-e2ee-模式的影响"},{depth:2,value:"数据结构定义",id:"数据结构定义"},{depth:3,value:"MessageContent",id:"messagecontent"},{depth:3,value:"RatchetHeader",id:"ratchetheader"},{depth:2,value:"Signal 协议流程说明 (E2EE 模式)",id:"signal-协议流程说明-e2ee-模式"},{depth:3,value:"初始会话建立 (PreKey 消息)",id:"初始会话建立-prekey-消息"},{depth:3,value:"后续消息 (Ratchet 消息)",id:"后续消息-ratchet-消息"},{depth:3,value:"服务器处理规则",id:"服务器处理规则-1"},{depth:3,value:"安全特性（E2EE 模式下）",id:"安全特性e2ee-模式下"}];function a(s){let e=Object.assign({h1:"h1",h2:"h2",p:"p",strong:"strong",ol:"ol",li:"li",code:"code",blockquote:"blockquote",hr:"hr",h3:"h3",ul:"ul",pre:"pre",span:"span",table:"table",thead:"thead",tr:"tr",th:"th",tbody:"tbody",td:"td",em:"em"},(0,o.a)(),s.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.h1,{children:"一对一聊天 (Private Chat)"}),"\n",(0,r.jsx)(e.h2,{id:"概述",children:"概述"}),"\n",(0,r.jsxs)(e.p,{children:["本部分定义了支持",(0,r.jsx)(e.strong,{children:"双模式"}),"的一对一私聊消息系统："]}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"端到端加密 (E2EE)模式"}),"：基于 Signal 协议，使用预共享密钥(PreKey)机制建立初始会话，然后使用双棘轮(Double Ratchet)算法进行后续消息加密。"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"明文模式"}),"：直接传输未经加密的文本消息，用于简化实现或特定非敏感场景。"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["客户端在发送消息时，将通过 ",(0,r.jsx)(e.code,{children:"MessageContent"})," 对象中的 ",(0,r.jsx)(e.code,{children:"type"})," 字段指明所使用的模式。服务器主要负责透明转发消息内容。"]}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"注意"}),'：本文档中所有时间戳字段在 API 中以 ISO8601 格式字符串表示（如"2025-05-15T11:05:00Z"），但在实际代码实现中使用 datetime 对象进行处理。']}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"31-发送私聊消息-send-private-message",children:"3.1. 发送私聊消息 (Send Private Message)"}),"\n",(0,r.jsxs)(e.h3,{id:"send_private_chat_message_request-client---server",children:[(0,r.jsx)(e.code,{children:"SEND_PRIVATE_CHAT_MESSAGE_REQUEST"})," (Client -> Server)"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"消息类型 ID"}),": ",(0,r.jsx)(e.code,{children:"201"})]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsxs)(e.strong,{children:["JSON ",(0,r.jsx)(e.code,{children:"type"})," 字符串"]}),": ",(0,r.jsx)(e.code,{children:'"SEND_PRIVATE_CHAT_MESSAGE_REQUEST"'})]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"JSON 示例 (E2EE - PreKey 消息):"})}),"\n",(0,r.jsx)(e.pre,{"data-language":"json","data-theme":"default",hasCopyCode:!0,children:(0,r.jsxs)(e.code,{"data-language":"json","data-theme":"default",children:[(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"{"})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"message_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"c7e0f3h2-gcd1-4d97-86f6-f0g3e9c1i2f3"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"type"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"SEND_PRIVATE_CHAT_MESSAGE_REQUEST"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"timestamp"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"2025-05-15T11:05:00Z"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"token"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"current_user_session_token"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"correlation_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"null"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"payload"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"recipient_user_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"usr_friend456"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"content"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"type"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"prekey"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"body"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"U29tZSBFbmNyeXB0ZWQgRGF0YQ=="'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"sender_identity_public_key"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"base64_sender_IK_pub"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"sender_ephemeral_public_key"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"base64_sender_EK_pub"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"recipient_signed_pre_key_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"123456"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"recipient_one_time_pre_key_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"123457"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        }"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"client_message_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"client_msg_uuid_001"'})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"JSON 示例 (明文消息):"})}),"\n",(0,r.jsx)(e.pre,{"data-language":"json","data-theme":"default",hasCopyCode:!0,children:(0,r.jsxs)(e.code,{"data-language":"json","data-theme":"default",children:[(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"{"})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"message_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"p9a8b7c6-d5e4-f3g2-h1i0-j9k8l7m6n5o4"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"type"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"SEND_PRIVATE_CHAT_MESSAGE_REQUEST"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"timestamp"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"2025-05-15T11:07:00Z"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"token"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"current_user_session_token"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"correlation_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"null"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"payload"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"recipient_user_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"usr_friend789"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"content"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"type"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"plaintext"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"body"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"你好，这是一条明文消息！"'})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        }"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"client_message_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"client_msg_uuid_002"'})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Payload 参数:"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"参数名"}),(0,r.jsx)(e.th,{children:"类型"}),(0,r.jsx)(e.th,{children:"Optional?"}),(0,r.jsx)(e.th,{children:"描述"}),(0,r.jsx)(e.th,{children:"示例"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"recipient_user_id"})}),(0,r.jsx)(e.td,{children:"string"}),(0,r.jsx)(e.td,{children:"否"}),(0,r.jsx)(e.td,{children:"消息接收者的用户 ID。"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"usr_friend456"'})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"content"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"MessageContent"})}),(0,r.jsx)(e.td,{children:"否"}),(0,r.jsxs)(e.td,{children:["消息内容对象。其具体结构和字段取决于 ",(0,r.jsx)(e.code,{children:"content.type"})," 的值。详见下方 ",(0,r.jsx)(e.code,{children:"MessageContent"})," 定义。"]}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"{...}"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"client_message_id"})}),(0,r.jsx)(e.td,{children:"string"}),(0,r.jsx)(e.td,{children:"是"}),(0,r.jsx)(e.td,{children:"客户端生成的消息 ID，用于追踪消息发送状态。服务端在 ACK 中会回显此 ID。"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"client_msg_uuid_001"'})})]})]})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsxs)(e.h3,{id:"private_chat_message_sent_ack-server---client-to-sender",children:[(0,r.jsx)(e.code,{children:"PRIVATE_CHAT_MESSAGE_SENT_ACK"})," (Server -> Client, to Sender)"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"消息类型 ID"}),": ",(0,r.jsx)(e.code,{children:"202"})," (通用于私聊和群聊消息发送确认)"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsxs)(e.strong,{children:["JSON ",(0,r.jsx)(e.code,{children:"type"})," 字符串"]}),": ",(0,r.jsx)(e.code,{children:'"PRIVATE_CHAT_MESSAGE_SENT_ACK"'})]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"此消息结构保持不变，因为它只确认服务器已处理消息，不关心内容是明文还是密文。"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"JSON 示例:"})}),"\n",(0,r.jsx)(e.pre,{"data-language":"json","data-theme":"default",hasCopyCode:!0,children:(0,r.jsxs)(e.code,{"data-language":"json","data-theme":"default",children:[(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"{"})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"message_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"sb1i9h8g-f6e5-5d13-9879-ihgfedb09876"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"type"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"PRIVATE_CHAT_MESSAGE_SENT_ACK"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"timestamp"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"2025-05-15T11:05:01Z"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"token"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"null"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"correlation_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"c7e0f3h2-gcd1-4d97-86f6-f0g3e9c1i2f3"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"payload"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"status_message"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Message processed by server."'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"server_message_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"srv_msg_xyz789"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"client_message_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"client_msg_uuid_001"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"message_timestamp"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"2025-05-15T11:05:00Z"'})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Payload 参数:"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"参数名"}),(0,r.jsx)(e.th,{children:"类型"}),(0,r.jsx)(e.th,{children:"Optional?"}),(0,r.jsx)(e.th,{children:"描述"}),(0,r.jsx)(e.th,{children:"示例"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"status_message"})}),(0,r.jsx)(e.td,{children:"string"}),(0,r.jsx)(e.td,{children:"否"}),(0,r.jsx)(e.td,{children:'消息处理状态 (例如 "Message processed by server", "Recipient offline, message stored").'}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"Message processed by server."'})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"server_message_id"})}),(0,r.jsx)(e.td,{children:"string"}),(0,r.jsx)(e.td,{children:"否"}),(0,r.jsx)(e.td,{children:"服务器为此消息生成的唯一 ID。"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"srv_msg_xyz789"'})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"client_message_id"})}),(0,r.jsx)(e.td,{children:"string"}),(0,r.jsx)(e.td,{children:"是"}),(0,r.jsx)(e.td,{children:"如果客户端在请求中提供了此 ID，服务器将其回显。"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"client_msg_uuid_001"'})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"message_timestamp"})}),(0,r.jsx)(e.td,{children:"string (ISO8601)"}),(0,r.jsx)(e.td,{children:"否"}),(0,r.jsxs)(e.td,{children:["消息在服务端被处理并分配 ",(0,r.jsx)(e.code,{children:"server_message_id"})," 时的精确时间戳。客户端应使用此时间戳更新本地消息记录。"]}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"2025-05-15T11:05:00Z"'})})]})]})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"32-接收私聊消息-receive-private-message",children:"3.2. 接收私聊消息 (Receive Private Message)"}),"\n",(0,r.jsxs)(e.h3,{id:"receive_private_chat_message_notification-server---client-to-recipient",children:[(0,r.jsx)(e.code,{children:"RECEIVE_PRIVATE_CHAT_MESSAGE_NOTIFICATION"})," (Server -> Client, to Recipient)"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"消息类型 ID"}),": ",(0,r.jsx)(e.code,{children:"203"})]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsxs)(e.strong,{children:["JSON ",(0,r.jsx)(e.code,{children:"type"})," 字符串"]}),": ",(0,r.jsx)(e.code,{children:'"RECEIVE_PRIVATE_CHAT_MESSAGE_NOTIFICATION"'})]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:["服务器将 ",(0,r.jsx)(e.code,{children:"SEND_PRIVATE_CHAT_MESSAGE_REQUEST"})," 中的 ",(0,r.jsx)(e.code,{children:"content"})," 对象原样转发给接收方。"]}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"JSON 示例 (E2EE - PreKey 消息):"})}),"\n",(0,r.jsx)(e.pre,{"data-language":"json","data-theme":"default",hasCopyCode:!0,children:(0,r.jsxs)(e.code,{"data-language":"json","data-theme":"default",children:[(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"{"})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"message_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"sc2j0i9h-g7f6-6e14-9870-jihgfedb0987"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"type"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"RECEIVE_PRIVATE_CHAT_MESSAGE_NOTIFICATION"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"timestamp"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"2025-05-15T11:05:02Z"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"token"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"null"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"correlation_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"null"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"payload"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"server_message_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"srv_msg_xyz789"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"sender_user_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"usr_sender123"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"sender_username"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"SenderName"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"content"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"type"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"prekey"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"body"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"U29tZSBFbmNyeXB0ZWQgRGF0YQ=="'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"sender_identity_public_key"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"base64_sender_IK_pub"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"sender_ephemeral_public_key"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"base64_sender_EK_pub"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"recipient_signed_pre_key_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"123456"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"recipient_one_time_pre_key_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"123457"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        }"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"message_timestamp"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"2025-05-15T11:05:00Z"'})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"JSON 示例 (明文消息):"})}),"\n",(0,r.jsx)(e.pre,{"data-language":"json","data-theme":"default",hasCopyCode:!0,children:(0,r.jsxs)(e.code,{"data-language":"json","data-theme":"default",children:[(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"{"})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"message_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"rd3k1j0i-h8g7-7f15-9871-kjihgfedcba0"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"type"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"RECEIVE_PRIVATE_CHAT_MESSAGE_NOTIFICATION"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"timestamp"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"2025-05-15T11:07:02Z"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"token"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"null"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"correlation_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"null"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"payload"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"server_message_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"srv_msg_abc123"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"sender_user_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"usr_another_sender"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"sender_username"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"AnotherSenderName"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"content"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"type"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"plaintext"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"body"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"你好，这是一条来自服务器转发的明文消息！"'})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        }"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"message_timestamp"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"2025-05-15T11:07:00Z"'})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Payload 参数:"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"参数名"}),(0,r.jsx)(e.th,{children:"类型"}),(0,r.jsx)(e.th,{children:"Optional?"}),(0,r.jsx)(e.th,{children:"描述"}),(0,r.jsx)(e.th,{children:"示例"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"server_message_id"})}),(0,r.jsx)(e.td,{children:"string"}),(0,r.jsx)(e.td,{children:"否"}),(0,r.jsx)(e.td,{children:"服务器为此消息生成的唯一 ID。"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"srv_msg_xyz789"'})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"sender_user_id"})}),(0,r.jsx)(e.td,{children:"string"}),(0,r.jsx)(e.td,{children:"否"}),(0,r.jsx)(e.td,{children:"消息发送者的用户 ID。"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"usr_sender123"'})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"sender_username"})}),(0,r.jsx)(e.td,{children:"string"}),(0,r.jsx)(e.td,{children:"否"}),(0,r.jsx)(e.td,{children:"消息发送者的用户名。"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"SenderName"'})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"content"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"MessageContent"})}),(0,r.jsx)(e.td,{children:"否"}),(0,r.jsxs)(e.td,{children:["消息内容对象。接收方客户端根据其内部的 ",(0,r.jsx)(e.code,{children:"type"})," 字段进行相应处理。详见 ",(0,r.jsx)(e.code,{children:"MessageContent"})," 定义。"]}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"{...}"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"message_timestamp"})}),(0,r.jsx)(e.td,{children:"string (ISO8601)"}),(0,r.jsx)(e.td,{children:"否"}),(0,r.jsx)(e.td,{children:"消息的原始发送时间戳（即发送方客户端创建消息时的时间戳）。"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"2025-05-15T11:05:00Z"'})})]})]})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.p,{children:"好的，我们将在您现有的一对一聊天协议基础上添加撤回消息的功能。"}),"\n",(0,r.jsx)(e.p,{children:"核心思路是："}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"发送方"})," 发起一个撤回请求，指明要撤回的",(0,r.jsxs)(e.strong,{children:["服务器消息 ID (",(0,r.jsx)(e.code,{children:"server_message_id"}),")"]}),"。"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"服务器"})," 验证请求（例如，是否是消息的原始发送者，是否在允许的时间窗口内——如果需要定义时间窗口的话），然后通知",(0,r.jsx)(e.strong,{children:"接收方"}),"该消息已被撤回。"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"接收方客户端"})," 收到撤回通知后，在其本地将对应消息标记为已撤回或直接移除。"]}),"\n",(0,r.jsx)(e.li,{children:"服务器也会给发送方一个撤回操作的确认。"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:'由于端到端加密 (E2EE) 的特性，服务器无法读取消息内容，也无法"删除"已发送到接收方设备并可能已被解密的消息内容。撤回操作本质上是发送一个"指令"，告知接收方客户端"请将 ID 为 X 的消息视为已撤回"。接收方客户端负责执行此操作。'}),"\n",(0,r.jsx)(e.p,{children:"以下是协议的补充部分："}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"33-撤回私聊消息-recall-private-message",children:"3.3. 撤回私聊消息 (Recall Private Message)"}),"\n",(0,r.jsxs)(e.p,{children:["本节定义了用户撤回已发送私聊消息的机制。撤回操作针对的是 ",(0,r.jsx)(e.code,{children:"server_message_id"}),"。"]}),"\n",(0,r.jsxs)(e.h3,{id:"331-recall_private_chat_message_request-client---server-from-sender",children:["3.3.1. ",(0,r.jsx)(e.code,{children:"RECALL_PRIVATE_CHAT_MESSAGE_REQUEST"})," (Client -> Server, from Sender)"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"消息类型 ID"}),": ",(0,r.jsx)(e.code,{children:"204"})]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsxs)(e.strong,{children:["JSON ",(0,r.jsx)(e.code,{children:"type"})," 字符串"]}),": ",(0,r.jsx)(e.code,{children:'"RECALL_PRIVATE_CHAT_MESSAGE_REQUEST"'})]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"当用户希望撤回一条已发送的消息时，客户端向服务器发送此请求。"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"JSON 示例:"})}),"\n",(0,r.jsx)(e.pre,{"data-language":"json","data-theme":"default",hasCopyCode:!0,children:(0,r.jsxs)(e.code,{"data-language":"json","data-theme":"default",children:[(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"{"})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"message_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"r3c4ll_req_uuid_001"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"type"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"RECALL_PRIVATE_CHAT_MESSAGE_REQUEST"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"timestamp"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"2025-05-15T11:10:00Z"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"token"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"current_user_session_token"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"correlation_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"null"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"payload"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"recipient_user_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"usr_friend456"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"server_message_id_to_recall"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"srv_msg_xyz789"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"client_recall_request_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"client_recall_uuid_001"'})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Payload 参数:"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"参数名"}),(0,r.jsx)(e.th,{children:"类型"}),(0,r.jsx)(e.th,{children:"Optional?"}),(0,r.jsx)(e.th,{children:"描述"}),(0,r.jsx)(e.th,{children:"示例"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"recipient_user_id"})}),(0,r.jsx)(e.td,{children:"string"}),(0,r.jsx)(e.td,{children:"否"}),(0,r.jsx)(e.td,{children:"原始消息接收者的用户 ID (即与谁的聊天会话中的消息)。"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"usr_friend456"'})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"server_message_id_to_recall"})}),(0,r.jsx)(e.td,{children:"string"}),(0,r.jsx)(e.td,{children:"否"}),(0,r.jsxs)(e.td,{children:["需要被撤回的消息在服务器端生成的唯一 ID (",(0,r.jsx)(e.code,{children:"server_message_id"}),")。"]}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"srv_msg_xyz789"'})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"client_recall_request_id"})}),(0,r.jsx)(e.td,{children:"string"}),(0,r.jsx)(e.td,{children:"是"}),(0,r.jsx)(e.td,{children:"客户端生成的撤回请求 ID，用于追踪撤回请求的状态。服务端在 ACK 中会回显此 ID。"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"client_recall_uuid_001"'})})]})]})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsxs)(e.h3,{id:"332-private_chat_message_recalled_ack-server---client-to-sender",children:["3.3.2. ",(0,r.jsx)(e.code,{children:"PRIVATE_CHAT_MESSAGE_RECALLED_ACK"})," (Server -> Client, to Sender)"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"消息类型 ID"}),": ",(0,r.jsx)(e.code,{children:"205"})]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsxs)(e.strong,{children:["JSON ",(0,r.jsx)(e.code,{children:"type"})," 字符串"]}),": ",(0,r.jsx)(e.code,{children:'"PRIVATE_CHAT_MESSAGE_RECALLED_ACK"'})]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"服务器在处理完撤回请求后，向发起撤回的客户端发送此确认消息。"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"JSON 示例 (成功):"})}),"\n",(0,r.jsx)(e.pre,{"data-language":"json","data-theme":"default",hasCopyCode:!0,children:(0,r.jsxs)(e.code,{"data-language":"json","data-theme":"default",children:[(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"{"})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"message_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"ack_recall_srv_uuid_002"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"type"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"PRIVATE_CHAT_MESSAGE_RECALLED_ACK"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"timestamp"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"2025-05-15T11:10:01Z"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"token"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"null"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"correlation_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"r3c4ll_req_uuid_001"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"payload"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"status"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"true"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"status_message"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Message recall request processed successfully."'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"recalled_server_message_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"srv_msg_xyz789"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"client_recall_request_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"client_recall_uuid_001"'})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"JSON 示例 (失败 - 例如消息不存在或超时):"})}),"\n",(0,r.jsx)(e.pre,{"data-language":"json","data-theme":"default",hasCopyCode:!0,children:(0,r.jsxs)(e.code,{"data-language":"json","data-theme":"default",children:[(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"{"})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"message_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"ack_recall_srv_uuid_003"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"type"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"PRIVATE_CHAT_MESSAGE_RECALLED_ACK"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"timestamp"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"2025-05-15T11:10:02Z"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"token"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"null"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"correlation_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"r3c4ll_req_uuid_002"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"payload"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"status"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"false"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"status_message"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"Message not found or recall window expired."'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"recalled_server_message_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"srv_msg_nonexistent123"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"client_recall_request_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"client_recall_uuid_002"'})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Payload 参数:"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"参数名"}),(0,r.jsx)(e.th,{children:"类型"}),(0,r.jsx)(e.th,{children:"Optional?"}),(0,r.jsx)(e.th,{children:"描述"}),(0,r.jsx)(e.th,{children:"示例"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"status"})}),(0,r.jsx)(e.td,{children:"bool"}),(0,r.jsx)(e.td,{children:"否"}),(0,r.jsx)(e.td,{children:"撤回操作是否成功"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"true"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"status_message"})}),(0,r.jsx)(e.td,{children:"string"}),(0,r.jsx)(e.td,{children:"否"}),(0,r.jsx)(e.td,{children:"描述撤回操作结果的消息。"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"Message recall request processed successfully."'})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"recalled_server_message_id"})}),(0,r.jsx)(e.td,{children:"string"}),(0,r.jsx)(e.td,{children:"否"}),(0,r.jsxs)(e.td,{children:["被尝试撤回的消息的 ",(0,r.jsx)(e.code,{children:"server_message_id"}),"。"]}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"srv_msg_xyz789"'})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"client_recall_request_id"})}),(0,r.jsx)(e.td,{children:"string"}),(0,r.jsx)(e.td,{children:"是"}),(0,r.jsx)(e.td,{children:"如果客户端在请求中提供了此 ID，服务器将其回显。"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"client_recall_uuid_001"'})})]})]})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsxs)(e.h3,{id:"333-receive_private_chat_message_recall_notification-server---client-to-recipient",children:["3.3.3. ",(0,r.jsx)(e.code,{children:"RECEIVE_PRIVATE_CHAT_MESSAGE_RECALL_NOTIFICATION"})," (Server -> Client, to Recipient)"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"消息类型 ID"}),": ",(0,r.jsx)(e.code,{children:"206"})]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsxs)(e.strong,{children:["JSON ",(0,r.jsx)(e.code,{children:"type"})," 字符串"]}),": ",(0,r.jsx)(e.code,{children:'"RECEIVE_PRIVATE_CHAT_MESSAGE_RECALL_NOTIFICATION"'})]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"当一条消息被发送者撤回后，服务器向该消息的接收方发送此通知。"}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"JSON 示例:"})}),"\n",(0,r.jsx)(e.pre,{"data-language":"json","data-theme":"default",hasCopyCode:!0,children:(0,r.jsxs)(e.code,{"data-language":"json","data-theme":"default",children:[(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"{"})}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"message_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"ntf_recall_srv_uuid_004"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"type"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"RECEIVE_PRIVATE_CHAT_MESSAGE_RECALL_NOTIFICATION"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"timestamp"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"2025-05-15T11:10:03Z"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"token"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"null"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"correlation_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-constant)"},children:"null"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"payload"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"server_message_id_to_recall"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"srv_msg_xyz789"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"recalled_by_user_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"usr_sender123"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"chat_partner_user_id"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"usr_sender123"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:","})]}),"\n",(0,r.jsxs)(e.span,{className:"line",children:[(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-keyword)"},children:'"recall_timestamp"'}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-punctuation)"},children:":"}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(e.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"2025-05-15T11:10:00Z"'})]}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"    }"})}),"\n",(0,r.jsx)(e.span,{className:"line",children:(0,r.jsx)(e.span,{style:{color:"var(--shiki-color-text)"},children:"}"})})]})}),"\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.strong,{children:"Payload 参数:"})}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"参数名"}),(0,r.jsx)(e.th,{children:"类型"}),(0,r.jsx)(e.th,{children:"Optional?"}),(0,r.jsx)(e.th,{children:"描述"}),(0,r.jsx)(e.th,{children:"示例"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"server_message_id_to_recall"})}),(0,r.jsx)(e.td,{children:"string"}),(0,r.jsx)(e.td,{children:"否"}),(0,r.jsxs)(e.td,{children:["被撤回的消息的 ",(0,r.jsx)(e.code,{children:"server_message_id"}),"。接收方客户端根据此 ID 找到并处理本地消息。"]}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"srv_msg_xyz789"'})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"recalled_by_user_id"})}),(0,r.jsx)(e.td,{children:"string"}),(0,r.jsx)(e.td,{children:"否"}),(0,r.jsx)(e.td,{children:"发起撤回操作的用户 ID (即原始消息的发送者)。"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"usr_sender123"'})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"chat_partner_user_id"})}),(0,r.jsx)(e.td,{children:"string"}),(0,r.jsx)(e.td,{children:"否"}),(0,r.jsx)(e.td,{children:"对于接收方而言，这是其聊天对象的 ID，即消息的发送者。"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"usr_sender123"'})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"recall_timestamp"})}),(0,r.jsx)(e.td,{children:"string (ISO8601)"}),(0,r.jsx)(e.td,{children:"否"}),(0,r.jsx)(e.td,{children:"撤回操作发生的原始时间戳（即发送方客户端发起撤回请求的时间）。"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"2025-05-15T11:10:00Z"'})})]})]})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"撤回消息处理规则-message-recall-handling-rules",children:"撤回消息处理规则 (Message Recall Handling Rules)"}),"\n",(0,r.jsx)(e.h3,{id:"服务器处理规则",children:"服务器处理规则:"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"验证请求"}),":\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["验证 ",(0,r.jsx)(e.code,{children:"token"})," 的有效性。"]}),"\n",(0,r.jsxs)(e.li,{children:["验证发起撤回请求的用户是否是 ",(0,r.jsx)(e.code,{children:"server_message_id_to_recall"})," 对应消息的原始发送者。"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"(可选)"})," 检查消息是否在允许的撤回时间窗口内（例如，发送后的 X 分钟内）。如果超出时间窗口，可以拒绝撤回。"]}),"\n",(0,r.jsx)(e.li,{children:"检查消息是否存在且尚未被撤回。"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"处理撤回"}),":\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"如果验证通过，服务器应记录该消息已被撤回（例如，在数据库中标记）。这可以防止将来再次尝试传递该消息（如果它之前因接收方离线而未送达）。"}),"\n",(0,r.jsxs)(e.li,{children:["向发起撤回的客户端发送 ",(0,r.jsx)(e.code,{children:"PRIVATE_CHAT_MESSAGE_RECALLED_ACK"}),"。"]}),"\n",(0,r.jsxs)(e.li,{children:["向消息的接收方客户端（",(0,r.jsx)(e.code,{children:"recipient_user_id"}),"）发送 ",(0,r.jsx)(e.code,{children:"RECEIVE_PRIVATE_CHAT_MESSAGE_RECALL_NOTIFICATION"}),"。如果接收方当前不在线，则在其下次上线时发送此通知，类似于离线消息推送。"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"E2EE 消息"}),": 对于 E2EE 消息，服务器无法访问或修改消息内容。撤回操作仅针对消息的元数据和传递状态。服务器的角色是通知相关客户端发生了撤回事件。"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"明文消息"}),": 对于明文消息，服务器理论上可以从其存储中删除消息体（如果它有存储的话），但主要目的仍然是通知客户端。"]}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"客户端处理规则-发送方",children:"客户端处理规则 (发送方):"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"发起撤回"}),": 用户选择撤回某条已发送的消息。客户端应使用该消息的 ",(0,r.jsx)(e.code,{children:"server_message_id"})," (在 ",(0,r.jsx)(e.code,{children:"PRIVATE_CHAT_MESSAGE_SENT_ACK"})," 中获得) 来构建 ",(0,r.jsx)(e.code,{children:"RECALL_PRIVATE_CHAT_MESSAGE_REQUEST"}),"。"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"处理确认"}),":\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["收到 ",(0,r.jsx)(e.code,{children:"PRIVATE_CHAT_MESSAGE_RECALLED_ACK"})," 后，根据 ",(0,r.jsx)(e.code,{children:"status"})," 更新本地 UI。"]}),"\n",(0,r.jsx)(e.li,{children:'如果成功，可以在本地将对应消息标记为"已撤回"或更新其显示状态。'}),"\n",(0,r.jsx)(e.li,{children:"如果失败 (例如超时、消息已被对方读取且服务器策略不允许再撤回等)，则向用户显示相应的错误信息。"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"客户端处理规则-接收方",children:"客户端处理规则 (接收方):"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"接收撤回通知"}),": 收到 ",(0,r.jsx)(e.code,{children:"RECEIVE_PRIVATE_CHAT_MESSAGE_RECALL_NOTIFICATION"}),"。"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"处理消息"}),":\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["根据 ",(0,r.jsx)(e.code,{children:"payload.server_message_id_to_recall"})," 找到本地存储的对应消息。"]}),"\n",(0,r.jsx)(e.li,{children:'将该消息标记为"已撤回"。UI 上通常会显示类似"此消息已被撤回"的提示，而不是直接删除，以免造成对话上下文的困惑。'}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"重要"}),": 如果消息是 E2EE 并且已被解密并存储在本地，客户端应确保该解密后的内容不再对用户可见。具体实现可以是删除解密内容，或用占位符替换。"]}),"\n",(0,r.jsxs)(e.li,{children:["如果收到针对一条不存在的 ",(0,r.jsx)(e.code,{children:"server_message_id"})," 的撤回通知（例如，由于网络延迟或状态不同步，消息在撤回通知到达前已被本地删除），客户端应静默忽略或记录一个低优先级的日志。"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"对-e2ee-模式的影响",children:"对 E2EE 模式的影响:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"撤回功能不破坏 E2EE 的安全性。服务器仍然不知道消息内容。"}),"\n",(0,r.jsx)(e.li,{children:'撤回的"效力"依赖于接收方客户端的正确实现。如果接收方客户端被篡改或不遵守协议，它可能不会隐藏已接收和解密的消息。'}),"\n",(0,r.jsx)(e.li,{children:"一旦消息在接收端被解密并显示，撤回操作无法保证消息内容完全从接收者的视野或记忆中消失，它主要是在应用层面移除消息的展示。"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"数据结构定义",children:"数据结构定义"}),"\n",(0,r.jsx)(e.h3,{id:"messagecontent",children:(0,r.jsx)(e.code,{children:"MessageContent"})}),"\n",(0,r.jsx)(e.p,{children:"用于承载消息内容，支持明文、Signal PreKey 和 Signal Ratchet 三种类型。"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"参数名"}),(0,r.jsx)(e.th,{children:"类型"}),(0,r.jsxs)(e.th,{children:[(0,r.jsx)(e.code,{children:"type"})," 条件"]}),(0,r.jsx)(e.th,{children:"描述"}),(0,r.jsx)(e.th,{children:"示例"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"type"})}),(0,r.jsx)(e.td,{children:"string (enum)"}),(0,r.jsx)(e.td,{children:"(所有类型共有)"}),(0,r.jsxs)(e.td,{children:["消息内容类型。必须是以下之一：",(0,r.jsx)(e.code,{children:'"plaintext"'}),", ",(0,r.jsx)(e.code,{children:'"prekey"'}),", ",(0,r.jsx)(e.code,{children:'"ratchet"'}),"。"]}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"prekey"'})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"body"})}),(0,r.jsx)(e.td,{children:"string"}),(0,r.jsx)(e.td,{children:"(所有类型共有)"}),(0,r.jsxs)(e.td,{children:["消息主体。如果 ",(0,r.jsx)(e.code,{children:"type"})," 为 ",(0,r.jsx)(e.code,{children:'"plaintext"'}),"，则为 UTF-8 明文字符串；如果为 ",(0,r.jsx)(e.code,{children:'"prekey"'})," 或 ",(0,r.jsx)(e.code,{children:'"ratchet"'}),"，则为 Base64 编码的密文字符串。"]}),(0,r.jsxs)(e.td,{children:[(0,r.jsx)(e.code,{children:'"Hello!"'})," 或 ",(0,r.jsx)(e.code,{children:'"U29tZSBFbmN..."'})]})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"sender_identity_public_key"})}),(0,r.jsx)(e.td,{children:"string"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"prekey"'})}),(0,r.jsxs)(e.td,{children:[(0,r.jsxs)(e.strong,{children:["仅当",(0,r.jsx)(e.code,{children:"type"}),"为",(0,r.jsx)(e.code,{children:'"prekey"'}),"时出现。"]})," 发送者的身份公钥 (IK_pub), Base64 编码。"]}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"base64_sender_IK_pub"'})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"sender_ephemeral_public_key"})}),(0,r.jsx)(e.td,{children:"string"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"prekey"'})}),(0,r.jsxs)(e.td,{children:[(0,r.jsxs)(e.strong,{children:["仅当",(0,r.jsx)(e.code,{children:"type"}),"为",(0,r.jsx)(e.code,{children:'"prekey"'}),"时出现。"]})," 发送者此次消息/会话的临时公钥 (EK_pub), Base64 编码。"]}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"base64_sender_EK_pub"'})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"recipient_signed_pre_key_id"})}),(0,r.jsx)(e.td,{children:"int"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"prekey"'})}),(0,r.jsxs)(e.td,{children:[(0,r.jsxs)(e.strong,{children:["仅当",(0,r.jsx)(e.code,{children:"type"}),"为",(0,r.jsx)(e.code,{children:'"prekey"'}),"时出现。"]})," 接收方被使用的签名预共享密钥(SPK)的 ID。"]}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"123456"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"recipient_one_time_pre_key_id"})}),(0,r.jsx)(e.td,{children:"int"}),(0,r.jsxs)(e.td,{children:[(0,r.jsx)(e.code,{children:'"prekey"'})," (可选)"]}),(0,r.jsxs)(e.td,{children:[(0,r.jsxs)(e.strong,{children:["仅当",(0,r.jsx)(e.code,{children:"type"}),"为",(0,r.jsx)(e.code,{children:'"prekey"'}),"时出现。"]})," 接收方被使用的一次性预共享密钥(OPK)的 ID (如果 OPK 被使用)。"]}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"123457"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"ratchet_header"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"RatchetHeader"})}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:'"ratchet"'})}),(0,r.jsxs)(e.td,{children:[(0,r.jsxs)(e.strong,{children:["仅当",(0,r.jsx)(e.code,{children:"type"}),"为",(0,r.jsx)(e.code,{children:'"ratchet"'}),"时出现。"]})," 包含双棘轮算法所需头部信息。如果",(0,r.jsx)(e.code,{children:"type"}),"不为",(0,r.jsx)(e.code,{children:'"ratchet"'}),"，此字段应为",(0,r.jsx)(e.code,{children:"null"}),"或不存在。"]}),(0,r.jsxs)(e.td,{children:[(0,r.jsx)(e.code,{children:"{...}"})," (参见 ",(0,r.jsx)(e.code,{children:"RatchetHeader"})," 定义)"]})]})]})]}),"\n",(0,r.jsx)(e.h3,{id:"ratchetheader",children:(0,r.jsx)(e.code,{children:"RatchetHeader"})}),"\n",(0,r.jsx)(e.p,{children:"用于双棘轮消息的头部信息（此结构保持不变）。"}),"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"参数名"}),(0,r.jsx)(e.th,{children:"类型"}),(0,r.jsx)(e.th,{children:"Optional?"}),(0,r.jsx)(e.th,{children:"描述"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"sender_ratchet_public_key"})}),(0,r.jsx)(e.td,{children:"string"}),(0,r.jsx)(e.td,{children:"否"}),(0,r.jsx)(e.td,{children:"发送方当前棘轮公钥 (例如 X25519 的公钥)，Base64 编码。接收方用于执行 DH 棘轮步骤。"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"message_number_in_chain"})}),(0,r.jsx)(e.td,{children:"int"}),(0,r.jsx)(e.td,{children:"否"}),(0,r.jsx)(e.td,{children:"此消息在当前发送链中的序号 (N)，从 0 开始计数。"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"previous_message_number_in_chain"})}),(0,r.jsx)(e.td,{children:"int"}),(0,r.jsx)(e.td,{children:"否"}),(0,r.jsxs)(e.td,{children:["发送方在",(0,r.jsx)(e.strong,{children:"上一个"}),"发送链（即上一次 DH 棘轮步骤之后）中已发送的消息总数 (PN)。用于处理乱序。"]})]})]})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.p,{children:"TODO：下面的内容后续移动到更加合适的文件里面"}),"\n",(0,r.jsx)(e.h2,{id:"signal-协议流程说明-e2ee-模式",children:"Signal 协议流程说明 (E2EE 模式)"}),"\n",(0,r.jsx)(e.h3,{id:"初始会话建立-prekey-消息",children:"初始会话建立 (PreKey 消息)"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"Alice 想要给 Bob 发送第一条 E2EE 消息"}),":"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["Alice 通过某种机制 (例如 ",(0,r.jsx)(e.code,{children:"QUERY_USER_PREKEYS_REQUEST"})," - ",(0,r.jsx)(e.em,{children:"此请求需要单独定义"}),") 获取 Bob 的公钥包 (包括身份公钥 IK_B, 签名预共享密钥 SPK_B, SPK_B 的签名 Sig(IK_B, Encode(SPK_B)), 和一组一次性预共享密钥 OPK_B)。"]}),"\n",(0,r.jsx)(e.li,{children:"Alice 验证 Bob 的 SPK_B 的签名。"}),"\n",(0,r.jsx)(e.li,{children:"Alice 生成自己的临时密钥对 EK_A。"}),"\n",(0,r.jsx)(e.li,{children:"Alice 使用 Signal 协议的 X3DH 密钥协商过程，结合自己的身份密钥 IK_A、临时密钥 EK_A，以及 Bob 的 IK_B、SPK_B (和可选的 OPK_B)，计算出初始的共享对称密钥 SK。"}),"\n",(0,r.jsxs)(e.li,{children:["Alice 使用 SK 加密消息，创建 ",(0,r.jsx)(e.code,{children:"MessageContent"})," 对象，其中：\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"type"})," 设置为 ",(0,r.jsx)(e.code,{children:'"prekey"'}),"。"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"body"})," 为加密后的密文 (Base64 编码)。"]}),"\n",(0,r.jsxs)(e.li,{children:["包含 ",(0,r.jsx)(e.code,{children:"sender_identity_public_key"})," (Alice 的 IK_A_pub Base64)。"]}),"\n",(0,r.jsxs)(e.li,{children:["包含 ",(0,r.jsx)(e.code,{children:"sender_ephemeral_public_key"})," (Alice 的 EK_A_pub Base64)。"]}),"\n",(0,r.jsxs)(e.li,{children:["包含 ",(0,r.jsx)(e.code,{children:"recipient_signed_pre_key_id"})," (Bob 被使用的 SPK_B 的 ID)。"]}),"\n",(0,r.jsxs)(e.li,{children:["如果使用了 Bob 的 OPK，则包含 ",(0,r.jsx)(e.code,{children:"recipient_one_time_pre_key_id"})," (Bob 被使用的 OPK_B 的 ID)。"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["Alice 发送 ",(0,r.jsx)(e.code,{children:"SEND_PRIVATE_CHAT_MESSAGE_REQUEST"}),"，其 ",(0,r.jsx)(e.code,{children:"payload.content"})," 为上述构建的 ",(0,r.jsx)(e.code,{children:"MessageContent"})," 对象。"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"Bob 接收 Alice 的 PreKey 消息"}),":"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["Bob 通过 ",(0,r.jsx)(e.code,{children:"RECEIVE_PRIVATE_CHAT_MESSAGE_NOTIFICATION"})," 收到消息，其中 ",(0,r.jsx)(e.code,{children:"payload.content"})," 包含 Alice 发来的 ",(0,r.jsx)(e.code,{children:"MessageContent"})," (",(0,r.jsx)(e.code,{children:'type="prekey"'}),")。"]}),"\n",(0,r.jsxs)(e.li,{children:["Bob 使用自己的私钥 (IK_B_priv, SPK_B_priv, 以及被使用的 OPK_B_priv) 和 Alice 消息中提供的公钥信息 (",(0,r.jsx)(e.code,{children:"sender_identity_public_key"}),", ",(0,r.jsx)(e.code,{children:"sender_ephemeral_public_key"}),")，同样通过 X3DH 过程重新计算出相同的共享对称密钥 SK。"]}),"\n",(0,r.jsxs)(e.li,{children:["Bob 使用 SK 解密 ",(0,r.jsx)(e.code,{children:"content.body"}),"，并初始化双棘轮会话状态。"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"后续消息-ratchet-消息",children:"后续消息 (Ratchet 消息)"}),"\n",(0,r.jsxs)(e.ol,{start:"3",children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"后续的对话"}),":\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Alice 和 Bob 使用已初始化的双棘轮算法进行后续消息加密。"}),"\n",(0,r.jsxs)(e.li,{children:["发送方创建 ",(0,r.jsx)(e.code,{children:"MessageContent"})," 对象，其中：\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"type"})," 设置为 ",(0,r.jsx)(e.code,{children:'"ratchet"'}),"。"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"body"})," 为使用当前消息密钥加密的密文 (Base64 编码)。"]}),"\n",(0,r.jsxs)(e.li,{children:["包含 ",(0,r.jsx)(e.code,{children:"ratchet_header"}),"，其中含有当前发送棘轮公钥、链内消息序号和上一链的消息数。"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["PreKey 特有的字段在 ",(0,r.jsx)(e.code,{children:"MessageContent"}),' (type="ratchet") 中不再出现。']}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"服务器处理规则-1",children:"服务器处理规则"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsxs)(e.strong,{children:["透明转发 ",(0,r.jsx)(e.code,{children:"content"})]}),": 服务器不修改 ",(0,r.jsx)(e.code,{children:"MessageContent"})," 对象内的任何字段。它将 ",(0,r.jsx)(e.code,{children:"SEND_PRIVATE_CHAT_MESSAGE_REQUEST"})," 中的 ",(0,r.jsx)(e.code,{children:"payload.content"})," 对象原封不动地放入 ",(0,r.jsx)(e.code,{children:"RECEIVE_PRIVATE_CHAT_MESSAGE_NOTIFICATION"})," 的 ",(0,r.jsx)(e.code,{children:"payload.content"})," 中转发给接收方。"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"不关心内容类型"}),": 服务器的转发逻辑不依赖于 ",(0,r.jsx)(e.code,{children:"MessageContent.type"})," 的具体值。"]}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"安全特性e2ee-模式下",children:"安全特性（E2EE 模式下）"}),"\n",(0,r.jsx)(e.p,{children:"（此部分与原文一致，因为基础的 Signal 协议特性未变）"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"前向安全性"}),": 双棘轮算法确保即使私钥泄露，过去的消息仍然安全。"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"后向安全性 / 未来保密性 (Post-Compromise Security)"}),": 如果会话状态在某个点被攻破，双棘轮算法能够通过 DH 交换自动恢复安全通信。"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"乱序消息处理"}),": 通过消息序号处理网络中的乱序消息。"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"密钥验证"}),": 身份公钥的参与和预共享密钥的签名有助于防止某些类型的攻击（但完整的身份验证可能还需要其他机制，如安全码比较）。"]}),"\n"]})]})}let d={MDXContent:function(){let s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:e}=Object.assign({},(0,o.a)(),s.components);return e?(0,r.jsx)(e,{...s,children:(0,r.jsx)(a,{...s})}):a(s)},pageOpts:{filePath:"pages/protocol/private_chat.md",route:"/protocol/private_chat",timestamp:1749055448e3,pageMap:[{kind:"Meta",data:{index:{title:"Introduction",type:"page",display:"hidden"},demo:{title:"Demo & Introduction",type:"page"},protocol:{title:"Protocol",type:"page"},sequence:{title:"Sequence Flow",type:"page"},database:{title:"Database Design",type:"page"},uml:{title:"UML Structure",type:"page"},"stress-test":{title:"Stress Testing",type:"page",display:"hidden"}}},{kind:"MdxPage",name:"database",route:"/database"},{kind:"MdxPage",name:"demo",route:"/demo"},{kind:"MdxPage",name:"index",route:"/"},{kind:"Folder",name:"protocol",route:"/protocol",children:[{kind:"Meta",data:{index:{title:"Protocol Overview",type:"page"},authentication:{title:"Authentication",type:"page"},private_chat:{title:"Private Chat",type:"page"},group_chat:{title:"Group Chat",type:"page"},presence:"Presence"}},{kind:"MdxPage",name:"authentication",route:"/protocol/authentication"},{kind:"MdxPage",name:"group_chat",route:"/protocol/group_chat"},{kind:"MdxPage",name:"index",route:"/protocol"},{kind:"MdxPage",name:"presence",route:"/protocol/presence"},{kind:"MdxPage",name:"private_chat",route:"/protocol/private_chat"}]},{kind:"MdxPage",name:"sequence",route:"/sequence"},{kind:"Folder",name:"sequences",route:"/sequences",children:[{kind:"MdxPage",name:"authentication",route:"/sequences/authentication"},{kind:"MdxPage",name:"group_chat",route:"/sequences/group_chat"},{kind:"MdxPage",name:"presence",route:"/sequences/presence"},{kind:"MdxPage",name:"private_chat",route:"/sequences/private_chat"},{kind:"Meta",data:{authentication:"Authentication",group_chat:"Group Chat",presence:"Presence",private_chat:"Private Chat"}}]},{kind:"MdxPage",name:"stress-test",route:"/stress-test"},{kind:"MdxPage",name:"uml",route:"/uml"}],flexsearch:{codeblocks:!0},readingTime:{text:"18 min read",minutes:17.67,time:1060200,words:3534},title:"一对一聊天 (Private Chat)",headings:t},pageNextRoute:"/protocol/private_chat",nextraLayout:l.ZP,themeConfig:c.Z};e.default=(0,i.j)(d)},3209:function(s,e,n){"use strict";var r=n(5893),i=n(7656),l=n(1163);let c={logo:(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)(i.Z,{size:24,className:"mr-2"}),(0,r.jsx)("span",{className:"font-bold text-xl",children:"Whisper Chat"})]}),project:{link:"https://github.com/ukeSJTU/whisper"},docsRepositoryBase:"https://github.com/ukeSJTU/whisper-docs",footer:{text:(0,r.jsxs)("span",{children:["\xa9 ",new Date().getFullYear()," Whisper Chat. All rights reserved."]})},useNextSeoProps(){let{asPath:s}=(0,l.useRouter)();return{titleTemplate:"/"!==s?"%s – Whisper Chat":"Whisper Chat - Secure Real-Time Communication",description:"Whisper is a modern, secure web-based chat application for real-time communication."}},head:(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("meta",{name:"viewport",content:"width=device-width, initial-scale=1.0"}),(0,r.jsx)("meta",{name:"description",content:"Whisper is a modern, secure web-based chat application for real-time communication."}),(0,r.jsx)("meta",{name:"og:title",content:"Whisper Chat"}),(0,r.jsx)("link",{rel:"icon",href:"/favicon.ico"})]}),banner:{key:"whisper-release",text:(0,r.jsxs)("span",{children:["\uD83C\uDF89 Try Whisper Chat online →"," ",(0,r.jsx)("a",{href:"https://whisper.ukehome.top",children:"whisper"})]})},primaryHue:{dark:260,light:180},navigation:{prev:!0,next:!0},darkMode:!0,nextThemes:{defaultTheme:"system"}};e.Z=c},5789:function(){}},function(s){s.O(0,[2114,2888,9774,179],function(){return s(s.s=8686)}),_N_E=s.O()}]);